<!DocTYPE html> 
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Projet final_Chichén Itzá</title>
<!-- A-Frame -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

<!-- =========================
       COMPOSANTS "BIBLIOTHÈQUE"
       ========================= -->
    <script> 
        AFRAME.registerComponent('player-controller'), {
      schema: {
        speed: { type: 'number', default: 3.5 },
        sprintMultiplier: { type: 'number', default: 1.6 }
      },
      init() {
        this.keys = Object.create(null);
        this.tmpVec3 = new THREE.Vector3();
        this.forward = new THREE.Vector3();
        this.right = new THREE.Vector3();
        window.addEventListener('keydown', (e) => { this.keys[e.code] = true; });
        window.addEventListener('keyup',   (e) => { this.keys[e.code] = false; });
      },
      tick(time, dt) {
        const dts = dt / 1000;
        if (!dts) return;
        // Inputs
        let x = 0, z = 0;
        if (this.keys['KeyW']) z -= 1;
        if (this.keys['KeyS']) z += 1;
        if (this.keys['KeyA']) x -= 1;
        if (this.keys['KeyD']) x += 1;

        if (x === 0 && z === 0) return;

        // Normalisation
        const len = Math.hypot(x, z);
        x /= len; z /= len;

        // Direction relative à la caméra (yaw uniquement)
        const cam = this.el.sceneEl.camera;
        if (!cam) return;

        this.forward.set(0, 0, -1).applyQuaternion(cam.quaternion);
        this.forward.y = 0; this.forward.normalize();

        this.right.copy(this.forward).cross(new THREE.Vector3(0, 1, 0)).normalize();

        // Vitesse
        let speed = this.data.speed;
        if (this.keys['ShiftLeft'] || this.keys['ShiftRight']) speed *= this.data.sprintMultiplier;

        // Δpos = right*x + forward*z
        this.tmpVec3.set(0,0,0);
        this.tmpVec3.addScaledVector(this.right, x);
        this.tmpVec3.addScaledVector(this.forward, z);
        this.tmpVec3.multiplyScalar(speed * dts);

        const obj = this.el.object3D;
        obj.position.add(this.tmpVec3);

        // Orienter le joueur dans la direction du mouvement (optionnel, utile en 3e personne)
        const yaw = Math.atan2(this.tmpVec3.x, this.tmpVec3.z);
        obj.rotation.y = yaw;
      }
    };
    AFRAME.registerComponent('third-person-camera', {
      schema: {
        target: { type: 'selector' },
        distance: { type: 'number', default: 4.2 },
        height: { type: 'number', default: 1.8 },
        sensitivity: { type: 'number', default: 0.12 },
        pitchMin: { type: 'number', default: -10 },
        pitchMax: { type: 'number', default: 55 }
      },
      init() {
        this.yaw = 180;   // derrière le joueur au départ
        this.pitch = 15;
        this.dragging = false;

        this.el.sceneEl.addEventListener('renderstart', () => {
          const canvas = this.el.sceneEl.canvas;
          if (!canvas) return;

          canvas.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return;
            this.dragging = true;
          });
          window.addEventListener('mouseup', () => { this.dragging = false; });
          window.addEventListener('mousemove', (e) => {
            if (!this.dragging) return;
            this.yaw   -= e.movementX * this.data.sensitivity;
            this.pitch -= e.movementY * this.data.sensitivity;
            this.pitch = Math.max(this.data.pitchMin, Math.min(this.data.pitchMax, this.pitch));
          });
        });
      },
      tick() {
        const target = this.data.target;
        if (!target) return;

        const t = target.object3D.position;

        const yawRad = THREE.MathUtils.degToRad(this.yaw);
        const pitchRad = THREE.MathUtils.degToRad(this.pitch);

        const r = this.data.distance;
        const cosP = Math.cos(pitchRad);

        const camX = t.x + r * Math.sin(yawRad) * cosP;
        const camY = t.y + this.data.height + r * Math.sin(pitchRad);
        const camZ = t.z + r * Math.cos(yawRad) * cosP;

        this.el.object3D.position.set(camX, camY, camZ);
        this.el.object3D.lookAt(t.x, t.y + this.data.height, t.z);
      }
    });

    AFRAME.registerComponent('info-on-click', {
      schema: {
        panel: { type: 'selector' },
        text:  { type: 'selector' },
        lines: { type: 'string', default: '' }
      },
      init() {
        this.index = 0;
        this.lines = (this.data.lines || '').split('|').map(s => s.trim()).filter(Boolean);

        this.el.classList.add('cliquable');

        this.el.addEventListener('click', () => {
          if (!this.data.panel || !this.data.text || this.lines.length === 0) return;

          this.data.panel.setAttribute('visible', true);
          this.data.text.setAttribute('value', this.lines[this.index]);

          this.index = (this.index + 1) % this.lines.length;
        });
      }
    });
//Guide 
     AFRAME.registerComponent('guide-dialogue', {
      schema: {
        panel: { type: 'selector' },
        text:  { type: 'selector' },
        lines: { type: 'string', default: '' }
      },
      init() {
        this.index = 0;
        this.lines = (this.data.lines || '').split('|').map(s => s.trim()).filter(Boolean);

        this.el.classList.add('cliquable');

        this.el.addEventListener('click', () => {
          if (!this.data.panel || !this.data.text || this.lines.length === 0) return;

          this.index = 0;
          this.data.panel.setAttribute('visible', true);
          this.data.text.setAttribute('value', this.lines[this.index]);
        });

        // Clic sur la bulle = phrase suivante
        if (this.data.panel) {
          this.data.panel.addEventListener('click', () => {
            if (this.lines.length === 0) return;
            this.index = (this.index + 1) % this.lines.length;
            this.data.text.setAttribute('value', this.lines[this.index]);
          });
        }
      }
    });
    //Bouton de fermeture pour les panneaux d'info
    AFRAME.registerComponent('hud-close', {
      schema: { target: { type: 'selector' } },
      init() {
        this.el.classList.add('cliquable');
        this.el.addEventListener('click', () => {
          if (this.data.target) this.data.target.setAttribute('visible', false);
        });
      }
    });
    </script>

    <body> 
    <!--Scène simplifiée : 
    - Déplacement 3e personne (clavier/souris), relatif à la caméra
    - Physique (système + objets dynamiques)
    - 2 composants mutualisables: info-on-click + guide-dialogue (+ hud-close) -->

    <a-scene 
    scale="3 3 3"
    render="colorManagement: true"
    background="color:#88ccff"
    physics="gravity: -9.8"
    spawn-physics-demo>

    <!-- Lumières -->
    <a-entity light="type: ambient; intensity: 1.2"></a-entity>
    <a-entity light="type: directional; intensity: 0.9" position="2 6 2"></a-entity>

    <!-- Sol + physique -->
    <a-plane
      position="0 0 -40"
      rotation="-90 0 0"
      width="100" height="100"
      src="#grass"
      static-body>
    </a-plane>

    <!-- Assets -->
    <a-assets>
      <img id="Kukulcan" src="models/volcanicrock.jpg">
      <img id="stone" src="models/Stone.JPG">
      <img id="grass" src="models/pastoo.JPG">

      <a-asset-item id="guide" src="models/guide.glb"></a-asset-item>
      <a-asset-item id="tzompantli" src="models/Tzompantli.glb"></a-asset-item>
      <a-asset-item id="cloud" src="models/cloud.glb"></a-asset-item>
   
    </a-assets>


    <!--Nuages-->
    <a-entity gltf-model="#cloud" position="8 123 27" scale="7 7 7"></a-entity>
    <a-entity gltf-model="#cloud" position="37 123 -180" scale="7 7 7"></a-entity>
    <a-entity gltf-model="#cloud" position="-111 123 -117" scale="7 7 7"></a-entity>
    <a-entity gltf-model="#cloud" position="-120 123 -4" scale="7 7 7"></a-entity>
    <a-entity gltf-model="#cloud" position="64 123 -62" scale="7 7 7"></a-entity>

    <!-- ===========
         JOUEUR + CAMÉRA 3e personne
         =========== -->
    <a-entity id="player" position="0 0 -2" player-controller="speed: 3.6;">
      <!-- Corps invisible (optionnel) -->
      <a-cylinder radius="0.25" height="1.7" position="0 0.85 0" opacity="0.0"></a-cylinder>
    </a-entity>

    <a-entity id="camRig" third-person-camera="target: #player; distance: 4.2; height: 1.8; sensitivity: 0.12;"></a-entity>
      <a-camera></a-camera>

      <!-- Cursor (clic souris) -->
      <a-entity
        cursor="fuse: false"
        raycaster="objects: .cliquable"
        position="0 0 -1"
        geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
        material="color: black; shader: flat">
      </a-entity>

      <!-- ===========
           HUD (panneaux UI)
           =========== -->
      <!-- Dialogue du guide -->
      <a-entity id="dialoguePanel" visible="false" position="0 -0.35 -1.2">
        <a-plane width="1.6" height="0.45" color="#000" opacity="0.65"></a-plane>
        <a-text id="dialogueValue" value="" align="center" color="#FFF" width="1.5" position="0 0 0.01"></a-text>
        <a-box position="0 -0.33 0.01" width="0.55" height="0.18" depth="0.02" color="#c44" hud-close="target: #dialoguePanel"></a-box>
        <a-text value="Fermer" position="0 -0.33 0.03" align="center" color="#FFF" width="1.0"></a-text>
      </a-entity>
      <!-- Panneau d'infos générique -->
      <a-entity id="infoPanel" visible="false" position="0 0.35 -1.2">
        <a-plane width="1.9" height="0.7" color="#FFF" opacity="0.92"></a-plane>
        <a-text id="infoValue" value="" align="center" color="#111" width="1.75" position="0 0.12 0.01"></a-text>
        <a-box position="0 -0.26 0.01" width="0.55" height="0.18" depth="0.02" color="#c44" hud-close="target: #infoPanel"></a-box>
        <a-text value="Fermer" position="0 -0.26 0.03" align="center" color="#FFF" width="1.0"></a-text>
      </a-entity>
    </a-entity>

    <!-- Guide (cliquable) -->
    <a-entity
      id="guide"
      gltf-model="#guide"
      position="-10 0 -82"
      scale="2 2 2"
      rotation="0 180 0"
      guide-dialogue="panel:#dialoguePanel; text:#dialogueValue; lines:
        Bonjour et bienvenue à la Ruta Maya.|
        Je m’appelle Aj Koo, je serai ton guide.|
        Clique sur les monuments pour en savoir plus.|
        WASD pour bouger, souris pour orienter la caméra.">
    </a-entity>

     <!-- Pyramide Maya : El Castillo -->
      <a-entity id="castillo" position="0 0 -45" scale="3 3 3" 
        info-on-click="panel:#infoPanel; text:#infoValue; lines:
        Vers l’an 435, la ville de Chichen Itzá est fondée.|
        Chichen signifie “bouche du puits”. Itzá renvoie aux Itzáes.|
        Voici El Castillo: temple religieux et astronomique.|
        Religion polythéiste: dieux dans les étoiles, la pluie, la terre.">
            <a-box position="0 0.5 0" width="10" depth="10" height="1" src="#Kukulcan"></a-box>
            <a-box position="0 1.5 0" width="9" depth="9" height="1" src="#Kukulcan"></a-box>
            <a-box position="0 2.5 0" width="8" depth="8" height="1" src="#Kukulcan"></a-box>
            <a-box position="0 3.5 0" width="7" depth="7" height="1" src="#Kukulcan"></a-box>
            <a-box position="0 4.5 0" width="6" depth="6" height="1" src="#Kukulcan"></a-box>
            <a-box position="0 5.5 0" width="5" depth="5" height="1" src="#Kukulcan"></a-box>
            <a-box position="0 6.5 0" width="4" depth="4" height="1" src="#Kukulcan"></a-box>
            <a-box position="0 7.5 0" width="3" depth="3" height="1" src="#Kukulcan"></a-box>
            <a-box position="0 8.5 0" width="2" depth="2" height="1" src="#Kukulcan"></a-box>
            <a-box position="0 9.5 0" width="1" depth="1" height="1" src="#Kukulcan"></a-box>
      </a-entity>

    <!-- Terrain de jeu de balle -->
        <a-entity id="pelota" position="-102 0 -167" scale="2 2 2" 
        info-on-click="panel:#infoPanel; text:#infoValue; lines:
        Ici nous jouons au pok-ta-pok (jeu de balle).|
        Jeu destiné à honorer les dieux et à équilibrer le monde.|
        Le ballon représente le soleil; les murs, les limites du cosmos.|
        Rituel: selon les récits, le sacrifice fait partie du symbolisme.">
            <a-box position="0 0.05 0" width="30" height="0.1" depth="6" color="#5a4e3c"></a-box>
            <a-box position="-15 2 0" width="0.5" height="4" depth="6" src="#stone"></a-box>
            <a-box position="15 2 0" width="0.5" height="4" depth="6" src="#stone"></a-box>
            <a-torus position="-14 3 0" radius="0.5" radius-tubular="0.1" rotation="0 0 90" color="#333"></a-torus>
            <a-torus position="14 3 0" radius="0.5" radius-tubular="0.1" rotation="0 0 90" color="#333"></a-torus>
        </a-entity>

    <!-- El Caracol Observatory -->
      <a-entity id="Caracol" position="-108 0 62" scale="3 3 3" 
      info-on-click="panel:#infoPanel; text:#infoValue; lines:
        Le Caracol est un observatoire (astronomie).|
        Les ouvertures sont alignées sur des astres/repères célestes.|
        Les Mayas ont développé des calendriers et des observations fines.">
        <a-box position="0 0.5 0" width="6" depth="6" height="1" src="#stone"></a-box>
        <a-box position="0 1.5 0" width="4.5" depth="4.5" height="1" src="#stone"></a-box>
        <a-cylinder position="0 3 0" radius="1.5" height="2" src="#stone"></a-cylinder>
        <a-sphere position="0 4.5 0" radius="1.2" color="#bfa980"></a-sphere>
        <a-box position="0 2.5 1.5" width="0.8" height="1" depth="0.1" color="#333"></a-box>
      </a-entity>
    
    <!-- Tzompantli -->
        <a-entity id="Tzompantli" gltf-model="#tzompantli" position="5 0 -180" scale="1 1 1" 
        info-on-click="panel:#infoPanel; text:#infoValue; lines:
        Le tzompantli est un râtelier de crânes utilisé dans les cultures mésoaméricaines.|
        Il servait à exposer les crânes de prisionniers ou de personnes sacrifiés par des fins religieuse."></a-entity>
    </a-scene>
</body>
